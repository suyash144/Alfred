<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alfred</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <style>
        .code-block {
            background-color: #f7f7f7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .figure-container {
            margin: 20px 0;
            text-align: center;
        }

        .figure-container img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }

        #conversation-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .history-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .assistant {
            color: #0066cc;
        }

        .user {
            color: #006600;
        }

        .feedback-input {
            height: 100px;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .history-figure {
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            background-color: #f9f9f9;
            text-align: center;
        }

        .figure {
            display: flex;
            justify-content: center;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px dashed #ccc;
            margin: 15px 0;
        }

        .figure-image {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .history-figure img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
        }

        .history-entry.figure {
            background-color: #f0f8ff;
            border-left: 3px solid #4a86e8;
        }

        .history-entry {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .button-group button {
                flex: 1 0 auto;
                margin-bottom: 8px;
            }
        }

        /* Button in execute state */
        #action-btn.btn-warning {
            background-color: #ff9800;
            border-color: #e68a00;
            transition: all 0.3s ease;
        }

        #action-btn.btn-warning:hover {
            background-color: #e68a00;
        }

        /* Button in stop state */
        #action-btn.btn-danger {
            background-color: #dc3545;
            border-color: #bd2130;
            transition: all 0.3s ease;
        }

        #action-btn.btn-danger:hover {
            background-color: #bd2130;
        }

        /* Button in analyze state */
        #action-btn.btn-success {
            background-color: #4caf50;
            border-color: #3d8b40;
            transition: all 0.3s ease;
        }

        #action-btn.btn-success:hover {
            background-color: #3d8b40;
        }

        /* Execute & Continue button */
        #execute-and-continue-btn {
            background-color: #2196f3;
            border-color: #0b7dda;
        }

        #execute-and-continue-btn:hover {
            background-color: #0b7dda;
        }

        /* Button transition animation */
        #action-btn {
            position: relative;
            overflow: hidden;
        }

        #action-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        #action-btn:active::after {
            transform: translateX(0);
        }

        /* Data source selection styles */
        .data-source-selector {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .file-upload-container {
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .uploaded-file-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9f7ef;
            border-radius: 5px;
            display: none;
        }

        #fileDetailsList {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .file-type-badge {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            margin-left: 5px;
        }

        .custom-prompt-container {
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .expandable-image {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .expandable-image:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Styling for the modal */
        #imageModal .modal-xl {
            max-width: 90vw;
        }

        #imageModal .modal-body {
            padding: 0;
            background-color: #f8f9fa;
            text-align: center;
        }

        #modalImage {
            max-height: 85vh;
            margin: 0 auto;
            object-fit: contain;
        }

        /* Zoom cursor for expandable images */
        .expandable-image {
            cursor: zoom-in !important;
        }

        /* Animation for modal opening */
        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
        }

        .modal.show .modal-dialog {
            transform: none;
        }

        #summary-content h2 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-top: 20px;
            font-size: 1.4rem;
        }

        #summary-content ul {
            padding-left: 20px;
        }

        #summary-content li {
            margin-bottom: 8px;
            position: relative;
        }

        #summary-content p {
            line-height: 1.6;
        }

        #summary-content code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 4px;
            color: #e83e8c;
        }

        #summary-content .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        /* Section-specific styling */
        #summary-content h2:nth-of-type(1) {
            color: #000000;
        }

        #summary-content h2:nth-of-type(2) {
            color: #000000;
        }

        #summary-content h2:nth-of-type(3) {
            color: #000000;
        }

        #summary-content h2:nth-of-type(4) {
            color: #000000;
        }

        /* Download button styles */
        #downloadImageBtn {
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #downloadImageBtn:hover {
            background-color: #0056b3;
        }

        #downloadImageBtn .spinner-border {
            margin-right: 0.5rem;
        }

        /* Improve modal footer layout */
        #imageModal .modal-footer {
            justify-content: space-between;
            padding: 1rem;
        }

        /* Add info text to footer */
        .image-info {
            color: #6c757d;
            font-size: 0.875rem;
            margin-right: auto;
        }

        .expandable-code {
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            margin-bottom: 16px;
            background-color: #f7f7f7;
            transition: all 0.3s ease;
        }
        
        .code-header {
            padding: 12px 15px;
            border-bottom: 1px solid #e1e4e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #f1f3f5;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        
        .code-line-count {
            font-size: 0.85rem;
            color: #6c757d;
            margin-left: auto;
            margin-right: 8px;
        }
        
        .expand-code-btn {
            padding: 2px 6px;
            font-size: 0.75rem;
        }
        
        .expandable-code.collapsed .code-full {
            display: none;
        }
        
        .expandable-code:not(.collapsed) .code-preview {
            display: none;
        }
        
        .code-full {
            padding: 0;
            margin: 0;
        }
        
        .code-full pre {
            margin: 0;
            border-top: none;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .expandable-code .expand-icon,
        .expandable-code .collapse-icon {
            display: inline-block;
            transition: transform 0.2s ease;
        }
        
        .expandable-code.collapsed .collapse-icon {
            display: none;
        }
        
        .expandable-code:not(.collapsed) .expand-icon {
            display: none;
        }

        /* Custom animation for the download button when clicked */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }

        #downloadImageBtn:active {
            animation: pulse 0.5s;
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="mb-4">Alfred</h1>

        <div class="data-source-selector">
            <h3>Select Data Source</h3>
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="dataSource" id="autoGeneratedData" value="auto"
                    checked>
                <label class="form-check-label" for="autoGeneratedData">
                    Use auto-generated test data
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="dataSource" id="customData" value="custom">
                <label class="form-check-label" for="customData">
                    Upload my own data
                </label>
            </div>

            <!-- File Upload Section (Initially Hidden) -->
            <div id="fileUploadSection" class="file-upload-container" style="display: none;">
                <div class="mb-3">
                    <label for="dataFile" class="form-label">Upload Data Files (.npy, .csv, .json)</label>
                    <input class="form-control" type="file" id="dataFile" accept=".npy,.csv,.json" multiple>
                    <div class="form-text">Supported formats: NumPy array (.npy), Json (.json) or CSV (.csv). You can select multiple
                        files.</div>
                </div>
                <div id="uploadedFileInfo" class="uploaded-file-info">
                    <p>Selected Files:</p>
                    <ul id="fileDetailsList" class="list-group">
                        <li class="list-group-item text-muted">No files selected</li>
                    </ul>
                </div>
            </div>

            <!-- Custom Prompt Section -->
            <div class="custom-prompt-container">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="useCustomPrompt">
                    <label class="form-check-label" for="useCustomPrompt">
                        Use custom initial prompt
                    </label>
                </div>
                <div id="customPromptSection" style="display: none;">
                    <div class="mb-3">
                        <label for="customPromptText" class="form-label">Enter your custom prompt</label>
                        <textarea class="form-control" id="customPromptText" rows="4"
                            placeholder="Give an initial description of your data and what you would like to find out."></textarea>
                        <div class="form-text">Your custom prompt will be added to the default analysis instruction.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col">
                <button id="initialize-btn" class="btn btn-primary">Initialise Dataset</button>
                <!-- <button id="get-analysis-btn" class="btn btn-success">Refresh History</button> -->
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">

                <!-- Text History Window -->
                <div class="mb-4">
                  <h4>Text History</h4>
                  <div id="text-history" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                    <!-- text entries go here -->
                  </div>
                </div>
            
                <!-- Figure History Window -->
                <div class="mb-4">
                    <h4>Figure History</h4>
                    <div id="figure-history" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                      <!-- figure entries go here -->
                    </div>
                </div>

                <!-- Code History Window -->
                <div class="mb-4">
                  <h4>Code History</h4>
                  <div id="code-history" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                    <!-- code entries go here -->
                  </div>
                </div>

            </div>

            <div class="col-md-6">
                <h3>Current Analysis</h3>
                <div id="current-analysis">
                    <div id="summary-section" style="display: none;">
                        <h4>Summary</h4>
                        <div id="summary-content" class="mb-4 p-3 border rounded"></div>
                    </div>

                    <div id="code-section" style="display: none;">
                        <h4>Proposed Code</h4>
                        <pre><code id="code-content" class="python"></code></pre>
                        <div class="button-group mt-3 mb-4">
                            <button id="action-btn" class="btn btn-warning">Execute Code</button>
                            <!-- <button id="execute-and-analyze-btn" class="btn btn-info ms-2">Execute & Continue</button> -->
                        </div>
                    </div>

                    <div id="feedback-section" style="display: none;">
                        <h4>Provide Feedback</h4>
                        <textarea id="feedback-input" class="form-control feedback-input mb-2"
                            placeholder="Enter your feedback here..."></textarea>
                        <button id="send-feedback-btn" class="btn btn-info">Send Feedback</button>
                    </div>

                    <div class="loading text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Processing...</p>
                    </div>
                </div>

                <div id="output-section" style="display: none;">
                    <h4>Execution Output</h4>
                    <pre id="output-content" class="p-3 border rounded bg-light"></pre>
                </div>

                <div id="figures-container">
                    <!-- Figures will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script>
        $(document).ready(function () {
            let currentSummary = '';
            let currentCode = '';
            let buttonState = 'execute';
            let selectedFiles = [];
            let codeExecutionInProgress = false;
            let executionId = null;
            let expandedCodeBlocks = [];

            // Toggle file upload section based on data source selection
            $('input[name="dataSource"]').change(function () {
                if ($(this).val() === 'custom') {
                    $('#fileUploadSection').slideDown();
                } else {
                    $('#fileUploadSection').slideUp();
                }
            });

            // Toggle custom prompt section
            $('#useCustomPrompt').change(function () {
                if ($(this).is(':checked')) {
                    $('#customPromptSection').slideDown();
                } else {
                    $('#customPromptSection').slideUp();
                }
            });

            // Handle multiple file selection
            $('#dataFile').change(function (e) {
                const files = e.target.files;
                if (files && files.length > 0) {
                    selectedFiles = Array.from(files);
                    $('#uploadedFileInfo').show();

                    // Clear and rebuild the file list
                    const $fileList = $('#fileDetailsList').empty();

                    selectedFiles.forEach(function (file, index) {
                        const fileSize = (file.size / 1024).toFixed(2);
                        const fileType = file.name.split('.').pop().toLowerCase();
                        const fileIcon = fileType === 'csv' ? '📊' : '📁';

                        $fileList.append(`
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${fileIcon} <strong>${file.name}</strong>
                                <span class="badge bg-primary rounded-pill">${fileSize} KB</span>
                            </li>
                        `);
                    });

                    // Add a summary message at the top
                    $('#uploadedFileInfo p').text(`Selected ${files.length} file${files.length > 1 ? 's' : ''}:`);

                } else {
                    selectedFiles = [];
                    $('#fileDetailsList').html('<li class="list-group-item text-muted">No files selected</li>');
                    $('#uploadedFileInfo p').text('Selected Files:');
                }
            });

            // Modified initialize dataset function
            $('#initialize-btn').click(function () {
                $('.loading').show();

                // Create a FormData object to handle file uploads
                const formData = new FormData();

                // Add data source type
                const dataSource = $('input[name="dataSource"]:checked').val();
                formData.append('dataSource', dataSource);

                // Add custom files if selected
                if (dataSource === 'custom' && selectedFiles.length > 0) {
                    // Append each file with a unique key (dataFile_0, dataFile_1, etc.)
                    selectedFiles.forEach((file, index) => {
                        formData.append(`dataFile_${index}`, file);
                    });
                    // Also add the file count for server-side processing
                    formData.append('fileCount', selectedFiles.length);
                } else if (dataSource === 'custom' && selectedFiles.length === 0) {
                    alert('Please select at least one file to upload');
                    $('.loading').hide();
                    return;
                }

                // Add custom prompt if specified
                if ($('#useCustomPrompt').is(':checked')) {
                    const customPrompt = $('#customPromptText').val().trim();
                    if (customPrompt) {
                        formData.append('customPrompt', customPrompt);
                    }
                }

                $.ajax({
                    url: '/initialize',
                    type: 'POST',
                    data: formData,
                    processData: false,  // Important for FormData
                    contentType: false,  // Important for FormData
                    success: function (response) {
                        alert(response.message);
                        // Clear conversation history
                        $('#text-history').empty();
                        $('#figure-history').empty();
                        $('#code-history').empty();
                        // Clear current analysis
                        $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                        $('#figures-container').empty();
                        console.log("Dataset initialised successfully");
                        console.log("Getting first analysis...");

                        // Keep loading indicator visible
                        $.ajax({
                            url: '/get_analysis',
                            type: 'GET',
                            success: function (response) {
                                $('.loading').hide();
                                console.log("Analysis response:", response);

                                if (response.status === 'success') {
                                    currentSummary = response.summary;
                                    currentCode = response.code;

                                    // Display summary
                                    $('#summary-content').html(markdownToHtml(response.summary));
                                    $('#summary-section').show();

                                    // Display code
                                    $('#code-content').text(response.code);
                                    hljs.highlightElement(document.getElementById('code-content'));
                                    $('#code-section').show();

                                    // Show feedback section
                                    $('#feedback-section').show();

                                    // Refresh conversation history after a short delay
                                    setTimeout(refreshConversationHistory, 500);

                                    // Set button to execute state
                                    setButtonState('execute');
                                } else {
                                    alert('Error: ' + response.message);
                                }
                            },
                            error: function (error) {
                                $('.loading').hide();
                                console.error("Analysis error:", error);
                                alert('Error getting analysis: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                            }
                        });
                    },
                    error: function (error) {
                        $('.loading').hide();
                        alert('Error initializing data: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                    }
                });
            });

            // Create the modal container for fullscreen images
            $(document).ready(function () {
                // Add the modal HTML to the page
                $('body').append(`
                        <div id="imageModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Image Viewer</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body text-center">
                                        <img id="modalImage" class="img-fluid" src="" alt="Expanded figure">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);

                // Function to make images clickable
                function makeImagesExpandable() {
                    // Target all images in conversation history
                    $('#figure-image').each(function () {
                        if (!$(this).hasClass('expandable-image')) {
                            $(this).addClass('expandable-image');
                            $(this).css('cursor', 'pointer');
                            $(this).attr('title', 'Click to expand');
                        }
                    });

                    // Target all images in figures container
                    $('#figures-container img').each(function () {
                        if (!$(this).hasClass('expandable-image')) {
                            $(this).addClass('expandable-image');
                            $(this).css('cursor', 'pointer');
                            $(this).attr('title', 'Click to expand');
                        }
                    });

                    // Target all images in history figures
                    $('.history-figure img').each(function () {
                        if (!$(this).hasClass('expandable-image')) {
                            $(this).addClass('expandable-image');
                            $(this).css('cursor', 'pointer');
                            $(this).attr('title', 'Click to expand');
                        }
                    });
                }

                // Event delegation for opening the modal
                $(document).on('click', '.expandable-image', function () {
                    const imgSrc = $(this).attr('src');
                    $('#modalImage').attr('src', imgSrc);
                    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
                    modal.show();
                });

                // Call the function initially
                makeImagesExpandable();

                // Set up an observer to make new images expandable as they're added
                const observer = new MutationObserver(function (mutations) {
                    mutations.forEach(function (mutation) {
                        if (mutation.addedNodes.length) {
                            makeImagesExpandable();
                        }
                    });
                });

                // Start observing the conversation history and figures container
                observer.observe(document.getElementById('figure-history'), {
                    childList: true,
                    subtree: true
                });

                observer.observe(document.getElementById('figures-container'), {
                    childList: true,
                    subtree: true
                });

                // Also make sure to call this after any dynamic content updates
                const originalRefreshHistory = refreshConversationHistory;
                refreshConversationHistory = function () {
                    originalRefreshHistory();
                    setTimeout(makeImagesExpandable, 500);
                };
            });
            
            // Dynamic action button - changes function based on state
            $('#action-btn').click(function () {
                if (buttonState === 'execute') {
                    executeCode();
                } else if (buttonState === 'stop') {
                    stopExecution();
                } else {
                    getNextAnalysis();
                }
            });

            // Add a download button to the image modal footer
            $(document).ready(function () {
                // Modify the existing modal footer to include a download button
                // Find the close button in the modal footer
                const closeButton = $('#imageModal .modal-footer button');

                // Add a download button before the close button
                closeButton.before(`
                <button type="button" id="downloadImageBtn" class="btn btn-primary me-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Save Image
                </button>
            `);

                // Add click handler for the download button
                $(document).on('click', '#downloadImageBtn', function () {
                    // Get the image src from the modal
                    const imgSrc = $('#modalImage').attr('src');

                    // Create a filename based on the current date/time or a default name
                    let filename = 'figure_' + new Date().toISOString().replace(/[:.]/g, '-') + '.png';

                    // If the image is from a data URL
                    if (imgSrc.startsWith('data:image')) {
                        // Convert data URL to blob
                        fetch(imgSrc)
                            .then(res => res.blob())
                            .then(blob => {
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.style.display = 'none';
                                a.href = url;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                                window.URL.revokeObjectURL(url);
                                a.remove();
                            })
                            .catch(err => {
                                console.error('Error saving image:', err);
                                alert('There was an error saving the image. Please try again.');
                            });
                    } else {
                        // For regular URLs
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = imgSrc;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    }
                });

                // Add a tooltip to the download button
                $('#downloadImageBtn').attr('title', 'Save this image to your device');

                // Make the button show a loading state when clicked
                $(document).on('click', '#downloadImageBtn', function () {
                    const $btn = $(this);
                    const originalHtml = $btn.html();

                    $btn.html(`
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Saving...
                `);

                    // Reset button after a short delay
                    setTimeout(() => {
                        $btn.html(originalHtml);
                    }, 1000);
                });
            });

            // Function to set button state and update appearance
            function setButtonState(state) {
                buttonState = state;
                const actionBtn = $('#action-btn');

                if (state === 'execute') {
                    actionBtn.text('Execute Code');
                    actionBtn.removeClass('btn-success btn-danger').addClass('btn-warning');
                } else if (state === 'stop') {
                    actionBtn.text('Stop Execution');
                    actionBtn.removeClass('btn-success btn-warning').addClass('btn-danger');
                } else {
                    actionBtn.text('Get Next Analysis');
                    actionBtn.removeClass('btn-warning btn-danger').addClass('btn-success');
                }
            }

            // Function to execute code
            function executeCode() {
                $('.loading').show();
                $('#output-section').hide();
                $('#figures-container').empty();
                
                // Set button to Stop Execution state
                setButtonState('stop');
                codeExecutionInProgress = true;

                console.log("Executing code...");

                // Generate a unique execution ID
                executionId = Date.now().toString();
                
                $.ajax({
                    url: '/execute_code',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        code: currentCode,
                        summary: currentSummary,
                        execution_id: executionId
                    }),
                    success: function (response) {
                        console.log("Code execution started:", response);
                        
                        // Start polling for results
                        pollExecutionResults(executionId);
                    },
                    error: function (error) {
                        $('.loading').hide();
                        codeExecutionInProgress = false;
                        console.error("Execution error:", error);
                        alert('Error starting code execution: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                        
                        // Reset button to execute state
                        setButtonState('execute');
                    }
                });
            }

            // Function to poll for execution results
            function pollExecutionResults(executionId) {
                if (!executionId) {
                    console.error("No execution ID provided for polling");
                    return;
                }
                
                const pollInterval = setInterval(function() {
                    if (!codeExecutionInProgress) {
                        clearInterval(pollInterval);
                        return;
                    }
                    
                    $.ajax({
                        url: `/execution_results/${executionId}`,
                        type: 'GET',
                        success: function (response) {
                            console.log("Poll response:", response);
                            
                            if (response.complete) {
                                // Clear the polling interval
                                clearInterval(pollInterval);
                                
                                // Hide loading indicator
                                $('.loading').hide();
                                codeExecutionInProgress = false;
                                
                                // Display output if available
                                if (response.output) {
                                    $('#output-content').text(response.output);
                                    $('#output-section').show();
                                }
                                
                                // Display figures if any
                                if (response.figures && response.figures.length > 0) {
                                    response.figures.forEach(function (figure, index) {
                                        const figureHtml = `
                                            <div class="figure-container">
                                                <h5>Figure ${index + 1}</h5>
                                                <img src="data:image/png;base64,${figure.data}" alt="Figure ${index + 1}">
                                            </div>
                                        `;
                                        $('#figures-container').append(figureHtml);
                                    });
                                }
                                
                                // Refresh conversation history after a short delay
                                setTimeout(refreshConversationHistory, 500);
                                
                                // Transform the button to "Get Next Analysis" if not cancelled
                                if (response.status !== 'cancelled') {
                                    setButtonState('analyze');
                                } else {
                                    setButtonState('execute');
                                }
                            }
                            // If not complete, we'll poll again
                        },
                        error: function (error) {
                            console.error("Error polling for results:", error);
                            clearInterval(pollInterval);
                            $('.loading').hide();
                            codeExecutionInProgress = false;
                            setButtonState('execute');
                        }
                    });
                }, 1000); // Poll every second
            }

            // Function to stop code execution
            function stopExecution() {
                if (!codeExecutionInProgress || !executionId) {
                    return;
                }
                
                console.log("Stopping code execution...");
                
                $.ajax({
                    url: '/stop_execution',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        execution_id: executionId
                    }),
                    success: function (response) {
                        console.log("Code execution stopped:", response);
                        
                        // Add message to output section
                        $('#output-content').text("Execution cancelled by user.");
                        $('#output-section').show();
                        
                        // Hide loading indicator
                        $('.loading').hide();
                        
                        // Reset execution state
                        codeExecutionInProgress = false;
                        
                        // Reset button to execute state
                        setButtonState('execute');
                        
                        // Refresh conversation history after a short delay
                        setTimeout(refreshConversationHistory, 500);
                    },
                    error: function (error) {
                        console.error("Error stopping execution:", error);
                        alert('Error stopping execution: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                    }
                });
            }

            function getNextAnalysis() {
                $('.loading').show();
                $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                $('#figures-container').empty();

                $.ajax({
                    url: '/get_analysis',
                    type: 'GET',
                    success: function (response) {
                        $('.loading').hide();
                        console.log("Analysis response:", response);

                        if (response.status === 'success') {
                            currentSummary = response.summary;
                            currentCode = response.code;

                            // Display summary
                            $('#summary-content').html(markdownToHtml(response.summary));
                            $('#summary-section').show();

                            // Display code
                            $('#code-content').text(response.code);
                            hljs.highlightElement(document.getElementById('code-content'));
                            $('#code-section').show();

                            // Show feedback section
                            $('#feedback-section').show();

                            // Refresh conversation history after a short delay
                            setTimeout(refreshConversationHistory, 500);

                            // Transform the button back to "Execute Code"
                            setButtonState('execute');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (error) {
                        $('.loading').hide();
                        console.error("Analysis error:", error);
                        alert('Error getting analysis: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                    }
                });
            }

            let userIsScrolling = false;
            let lastScrollTop = 0;

            // Detect manual scrolling
            $('#text-history').on('scroll', function () {
                userIsScrolling = true;
                lastScrollTop = $(this).scrollTop();

                // Reset the flag after 2 seconds of no scrolling
                clearTimeout($.data(this, 'scrollTimer'));
                $.data(this, 'scrollTimer', setTimeout(function () {
                    userIsScrolling = false;
                }, 2000));
            });

            // Send feedback button
            $('#send-feedback-btn').click(function () {
                const feedback = $('#feedback-input').val().trim();
                if (!feedback) {
                    alert('Please enter feedback before sending.');
                    return;
                }

                $('.loading').show();
                console.log("Sending feedback and getting next analysis...");

                $.ajax({
                    url: '/send_feedback',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        feedback: feedback,
                        summary: currentSummary,
                        code: currentCode
                    }),
                    success: function (response) {
                        console.log("Feedback response:", response);

                        // Clear feedback input
                        $('#feedback-input').val('');

                        // Hide sections during transition
                        $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                        $('#figures-container').empty();

                        // First refresh conversation history
                        refreshConversationHistory();

                        // Check if we have a next analysis from the server
                        if (response.next_analysis) {
                            // Update with the new analysis data
                            currentSummary = response.next_analysis.summary;
                            currentCode = response.next_analysis.code;

                            // Display summary
                            $('#summary-content').html(markdownToHtml(response.next_analysis.summary));
                            $('#summary-section').show();

                            // Display code
                            $('#code-content').text(response.next_analysis.code);
                            hljs.highlightElement(document.getElementById('code-content'));
                            $('#code-section').show();

                            // Show feedback section
                            $('#feedback-section').show();

                            // Set button to execute state
                            setButtonState('execute');

                            // Hide loading indicator when complete
                            $('.loading').hide();

                            // Final refresh of conversation history to ensure everything is up to date
                            setTimeout(refreshConversationHistory, 500);
                        } else if (response.error) {
                            // If there was an error getting the next analysis
                            $('.loading').hide();
                            alert('Note: Your feedback was sent, but there was an error getting the next analysis: ' + response.error);
                        } else {
                            // If response doesn't contain next_analysis for some reason
                            $('.loading').hide();
                            alert('Your feedback was sent successfully, but no next analysis was received.');
                        }
                    },
                    error: function (error) {
                        $('.loading').hide();
                        console.error("Feedback error:", error);
                        alert('Error sending feedback: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                    }
                });
            });

            // Function to refresh conversation history with direct DOM manipulation
            function refreshConversationHistory() {
                console.log("Refreshing conversation history...");
                
                // Track scrolling for the text panel only
                const $textPanel = $('#text-history');
                // const oldScrollTop = $textPanel.scrollTop();
                // const oldScrollHeight = $textPanel[0].scrollHeight;
                
                // Store current history entry count
                const oldHistoryLength = $textPanel.find('.history-entry').length;
                
                $.ajax({
                    url: '/debug/history',
                    type: 'GET',
                    success: function (response) {
                        if (response.history && response.history.length > 0) {
                            // Only rebuild if number of entries has changed
                            if (response.history.length !== oldHistoryLength) {
                                // Populate all three windows
                                populateHistoryWindows(response.history);
                                
                            }
                        } else if (response.history && response.history.length === 0) {
                            // If there's no conversation
                            $('#text-history').html('<p>No conversation history yet.</p>');
                            $('#code-history').html('<p>No code history yet.</p>');
                            $('#figure-history').html('<p>No figure history yet.</p>');
                        }

                    },
                    error: function (error) {
                        console.error("Error refreshing history:", error);
                    }
                });
            }

            // Update Get Analysis button handler to include history refresh
            $('#get-analysis-btn').click(function () {
                $('.loading').show();
                $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                $('#figures-container').empty();

                $.ajax({
                    url: '/get_analysis',
                    type: 'GET',
                    success: function (response) {
                        $('.loading').hide();
                        console.log("Analysis response:", response);

                        if (response.status === 'success') {
                            currentSummary = response.summary;
                            currentCode = response.code;

                            // Display summary
                            $('#summary-content').html(markdownToHtml(response.summary));
                            $('#summary-section').show();

                            // Display code
                            $('#code-content').text(response.code);
                            hljs.highlightElement(document.getElementById('code-content'));
                            $('#code-section').show();

                            // Show feedback section
                            $('#feedback-section').show();

                            // Refresh conversation history after a short delay
                            setTimeout(refreshConversationHistory, 500);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (error) {
                        $('.loading').hide();
                        console.error("Analysis error:", error);
                        alert('Error getting analysis: ' + error.responseJSON ? error.responseJSON.message : 'Unknown error');
                    }
                });
            });

            // Enforce regular history refresh
            $(document).ready(function () {
                // Initial load
                refreshConversationHistory();

                // Clear any existing intervals (in case of page refresh)
                if (window.historyRefreshInterval) {
                    clearInterval(window.historyRefreshInterval);
                }

                // Set up a less aggressive refresh interval
                window.historyRefreshInterval = setInterval(function () {
                    // Only auto-refresh if user is not actively scrolling
                    if (!userIsScrolling) {
                        refreshConversationHistory();
                    }
                }, 5000); // Every 5 seconds instead of 3
            });

            // Simple markdown to HTML converter (just for basic formatting)
            function markdownToHtml(markdown) {
                if (!markdown) return '';

                // Convert headers
                let html = markdown
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>');

                // Convert bold and italic
                html = html
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');

                // Convert lists
                html = html
                    .replace(/^\s*\d+\.\s+(.*$)/gm, '<li>$1</li>')
                    .replace(/^\s*[\-\*]\s+(.*$)/gm, '<li>$1</li>');

                // Wrap lists
                html = html
                    .replace(/<\/li>\n<li>/g, '</li><li>')
                    .replace(/(<li>.*?<\/li>)/s, '<ul>$1</ul>');

                // Convert paragraphs
                html = html
                    .replace(/\n\s*\n/g, '</p><p>')
                    .replace(/^(.+)$/gm, function (match) {
                        if (match.startsWith('<')) return match;
                        return `<p>${match}</p>`;
                    });

                return html;
            }

            function populateHistoryWindows(historyArray) {
                const textWindow = document.getElementById('text-history');
                const codeWindow = document.getElementById('code-history');
                const figureWindow = document.getElementById('figure-history');
                const previewLines = 1;

                // Clear each
                textWindow.innerHTML = '';
                codeWindow.innerHTML = '';
                figureWindow.innerHTML = '';

                let roleClass = 'user';

                historyArray.forEach((entry, entryIndex) => {
                    const { role, type, iteration, content } = entry;
                    const iterationLabel = `<strong>Iteration ${iteration}:</strong>`;

                    if (type === 'text') {
                        if (role == 'assistant') {
                            roleClass = 'assistant';
                        } else {
                            roleClass = 'user';
                        }
                    // Plain conversation text
                    textWindow.innerHTML += `
                        <div class="history-entry ${roleClass}">
                        ${iterationLabel} <strong>${role.toUpperCase()}</strong>
                        <div>${content}</div>
                        </div>`;
                    } else if (type === 'code') {
                    // Check what kind of code content we have
                    let displayContent = content;
                    let isCodeOutput = false;
                    
                    // Check if it starts with 'Proposed code:'
                    if (content.startsWith('Proposed code:')) {
                        displayContent = content.substring('Proposed code:'.length).trim();
                    } 
                    // Check if it starts with 'Code Output:'
                    else if (content.startsWith('Code Output:')) {
                        displayContent = content.substring('Code Output:'.length).trim();
                        isCodeOutput = true;
                    }
                    // Check for error messages
                    else if (content.startsWith('Error while running code:')) {
                        displayContent = content.substring('Error while running code:'.length).trim();
                        isCodeOutput = true;
                    }
                    else if (content.startsWith('Execution error:')) {
                        displayContent = content.substring('Execution error:'.length).trim();
                        isCodeOutput = true;
                    }
                    else if (content.startsWith('Execution timed out:')) {
                        displayContent = content.substring('Execution timed out:'.length).trim();
                        isCodeOutput = true;
                    }
                    
                    if (isCodeOutput) {
                        // Display code output as text in the code window
                        codeWindow.innerHTML += `
                            <div class="history-entry">
                            ${iterationLabel} <strong>CODE OUTPUT</strong>
                            <div class="p-2 bg-light border rounded">${displayContent}</div>
                            </div>`;
                    } else {
                        const blockId = `code-block-${iteration}-${entryIndex}`;
                        const wasExpanded = expandedCodeBlocks.includes(blockId);
                        const codeLines = displayContent.split('\n').length;
                        codeWindow.innerHTML += `
                            <div class="history-entry code-block expandable-code ${wasExpanded ? '' : 'collapsed'}" data-block-id="${blockId}">
                                <div class="code-header">
                                    ${iterationLabel} <strong>&nbspCODE</strong>
                                    <span class="code-line-count">${codeLines} lines</span>
                                    <button class="btn btn-sm btn-outline-secondary expand-code-btn">
                                        <span class="expand-icon">▼</span><span class="collapse-icon">▲</span>
                                    </button>
                                </div>
                                <div class="code-full">
                                    <pre><code>${displayContent}</code></pre>
                                </div>
                            </div>`;
                    }
                    } else if (type === 'figure') {
                    // Figures
                    figureWindow.innerHTML += `
                        <div class="history-entry">
                        ${iterationLabel} <strong>FIGURES</strong>
                        <img src="${content}" alt="Figure" class="figure-image expandable-image" />
                        </div>`;
                    }
                });
                // Re-highlight any code blocks in the code window
                codeWindow.querySelectorAll('code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                setupExpandableCodeBlocks();

            }
            
            function setupExpandableCodeBlocks() {
                document.querySelectorAll('.expandable-code').forEach(codeBlock => {
                    const blockId = codeBlock.dataset.blockId;
                    const expandBtn = codeBlock.querySelector('.expand-code-btn');
                    
                    if (expandBtn) {
                        expandBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            codeBlock.classList.toggle('collapsed');
                            
                            // Update the expandedCodeBlocks array
                            if (!codeBlock.classList.contains('collapsed')) {
                                // Block is expanded, add to array if not already there
                                if (!expandedCodeBlocks.includes(blockId)) {
                                    expandedCodeBlocks.push(blockId);
                                }
                                
                                // Highlight code when expanded
                                const codeElement = codeBlock.querySelector('code');
                                if (codeElement) {
                                    hljs.highlightElement(codeElement);
                                }
                            } else {
                                // Block is collapsed, remove from array
                                expandedCodeBlocks = expandedCodeBlocks.filter(id => id !== blockId);
                            }
                        });
                    }
                    
                    // Also make the preview clickable with the same behavior
                    const preview = codeBlock.querySelector('.code-preview');
                    if (preview) {
                        preview.addEventListener('click', function() {
                            expandBtn.click(); // Reuse the button click handler
                        });
                    }
                });
            }
            
            codeWindow.querySelectorAll('code').forEach((block) => {
                hljs.highlightElement(block);
            });
            // Logging middleware for debugging
            $(document).ajaxSend(function (event, jqxhr, settings) {
                console.log("Ajax request:", settings.type, settings.url);
            });

            $(document).ajaxComplete(function (event, jqxhr, settings) {
                console.log("Ajax complete:", settings.type, settings.url, "Status:", jqxhr.status);
            });
        });

        // Image expansion modal
        $(document).ready(function () {

            // Also call after refreshing history
            const originalRefreshHistory = refreshConversationHistory;
            refreshConversationHistory = function () {
                originalRefreshHistory();
                setTimeout(makeImagesExpandable, 500);
            };

            // Enhanced markdown to HTML function
            window.markdownToHtml = function (markdown) {
                if (!markdown) return '';

                // Extract sections to apply our structured format
                const sections = extractSections(markdown);

                // Convert headers
                let html = markdown
                    .replace(/^### (.*$)/gm, '<h3 class="mt-4 mb-3">$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2 class="mt-4 mb-3">$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1 class="mt-4 mb-3">$1</h1>');

                // Convert bold and italic
                html = html
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');

                // Convert lists with better styling
                html = html
                    .replace(/^\s*\d+\.\s+(.*$)/gm, '<li class="mb-1">$1</li>')
                    .replace(/^\s*[\-\*]\s+(.*$)/gm, '<li class="mb-1">$1</li>');

                // Wrap lists with proper Bootstrap classes
                html = html
                    .replace(/<\/li>\n<li>/g, '</li><li>')
                    .replace(/(<li class="mb-1">.*?<\/li>)/gs, (match) => {
                        return '<ul class="list-group list-group-flush mb-3">' + match + '</ul>';
                    });

                // Convert code blocks
                html = html.replace(/```([\s\S]*?)```/g, '<pre class="bg-light p-3 rounded"><code>$1</code></pre>');

                // Convert inline code
                html = html.replace(/`([^`]+)`/g, '<code class="bg-light px-1 rounded">$1</code>');

                // Convert paragraphs with better spacing
                html = html
                    .replace(/\n\s*\n/g, '</p><p class="mb-3">')
                    .replace(/^(.+)$/gm, function (match) {
                        if (match.startsWith('<')) return match;
                        return `<p class="mb-3">${match}</p>`;
                    });

                return html;
            };

            // Function to extract sections from markdown
            function extractSections(markdown) {
                const sections = {
                    interpretation: '',
                    understanding: '',
                    questions: '',
                    proposed: ''
                };

                // Look for interpretation section
                const interpretationRegex = /## *Interpretation(?:.*?)\n([\s\S]*?)(?=\n## |\n# |$)/i;
                const interpretationMatch = markdown.match(interpretationRegex);
                if (interpretationMatch) {
                    sections.interpretation = interpretationMatch[1].trim();
                }

                // Look for understanding section
                const understandingRegex = /## *Current understanding(?:.*?)\n([\s\S]*?)(?=\n## |\n# |$)/i;
                const understandingMatch = markdown.match(understandingRegex);
                if (understandingMatch) {
                    sections.understanding = understandingMatch[1].trim();
                }

                // Look for questions section
                const questionsRegex = /## *Open questions(?:.*?)\n([\s\S]*?)(?=\n## |\n# |$)/i;
                const questionsMatch = markdown.match(questionsRegex);
                if (questionsMatch) {
                    sections.questions = questionsMatch[1].trim();
                }

                // Look for proposed next analysis section
                const proposedRegex = /## *Proposed next(?:.*?)\n([\s\S]*?)(?=\n## |\n# |$)/i;
                const proposedMatch = markdown.match(proposedRegex);
                if (proposedMatch) {
                    sections.proposed = proposedMatch[1].trim();
                }

                return sections;
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive EDA with LLM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <style>
        .code-block {
            background-color: #f7f7f7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .figure-container {
            margin: 20px 0;
            text-align: center;
        }
        .figure-container img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        #conversation-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .history-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .assistant {
            color: #0066cc;
        }
        .user {
            color: #006600;
        }
        .feedback-input {
            height: 100px;
        }
        .loading {
            display: none;
            margin: 20px 0;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Interactive EDA with LLM</h1>
        
        <div class="row mb-4">
            <div class="col">
                <button id="initialize-btn" class="btn btn-primary">Initialize Dataset</button>
                <button id="get-analysis-btn" class="btn btn-success">Get Next Analysis Step</button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Conversation History</h3>
                <div id="conversation-history">
                    <!-- History will be loaded dynamically via JavaScript -->
                    <p>Loading conversation history...</p>
                </div>
            </div>
            
            <div class="col-md-6">
                <h3>Current Analysis</h3>
                <div id="current-analysis">
                    <div id="summary-section" style="display: none;">
                        <h4>Summary</h4>
                        <div id="summary-content" class="mb-4 p-3 border rounded"></div>
                    </div>
                    
                    <div id="code-section" style="display: none;">
                        <h4>Proposed Code</h4>
                        <pre><code id="code-content" class="python"></code></pre>
                        <button id="execute-btn" class="btn btn-warning">Execute Code</button>
                    </div>
                    
                    <div id="feedback-section" style="display: none;">
                        <h4>Provide Feedback</h4>
                        <textarea id="feedback-input" class="form-control feedback-input mb-2" placeholder="Enter your feedback here..."></textarea>
                        <button id="send-feedback-btn" class="btn btn-info">Send Feedback</button>
                    </div>
                    
                    <div class="loading text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Processing...</p>
                    </div>
                </div>
                
                <div id="output-section" style="display: none;">
                    <h4>Execution Output</h4>
                    <pre id="output-content" class="p-3 border rounded bg-light"></pre>
                </div>
                
                <div id="figures-container">
                    <!-- Figures will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script>
        $(document).ready(function() {
            let currentSummary = '';
            let currentCode = '';
            
            // Initialize dataset
            $('#initialize-btn').click(function() {
                $('.loading').show();
                $.ajax({
                    url: '/initialize',
                    type: 'POST',
                    success: function(response) {
                        $('.loading').hide();
                        alert(response.message);
                        // Clear conversation history
                        $('#conversation-history').empty();
                        // Clear current analysis
                        $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                        $('#figures-container').empty();
                    },
                    error: function(error) {
                        $('.loading').hide();
                        alert('Error initializing data: ' + error.responseJSON.message);
                    }
                });
            });

            let userIsScrolling = false;
            let lastScrollTop = 0;

            // Detect manual scrolling
            $('#conversation-history').on('scroll', function() {
                userIsScrolling = true;
                lastScrollTop = $(this).scrollTop();
                
                // Reset the flag after 2 seconds of no scrolling
                clearTimeout($.data(this, 'scrollTimer'));
                $.data(this, 'scrollTimer', setTimeout(function() {
                    userIsScrolling = false;
                }, 2000));
            });
            
            // Get analysis
            $('#get-analysis-btn').click(function() {
                $('.loading').show();
                $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                $('#figures-container').empty();
                
                $.ajax({
                    url: '/get_analysis',
                    type: 'GET',
                    success: function(response) {
                        $('.loading').hide();
                        if (response.status === 'success') {
                            currentSummary = response.summary;
                            currentCode = response.code;
                            
                            // Display summary
                            $('#summary-content').html(markdownToHtml(response.summary));
                            $('#summary-section').show();
                            
                            // Display code
                            $('#code-content').text(response.code);
                            hljs.highlightElement(document.getElementById('code-content'));
                            $('#code-section').show();
                            
                            // Show feedback section
                            $('#feedback-section').show();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(error) {
                        $('.loading').hide();
                        alert('Error getting analysis: ' + error.responseJSON.message);
                    }
                });
            });
            
            // Execute code
            $('#execute-btn').click(function() {
                $('.loading').show();
                $('#output-section').hide();
                $('#figures-container').empty();
                
                console.log("Executing code...");
                
                $.ajax({
                    url: '/execute_code',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 
                        code: currentCode,
                        summary: currentSummary 
                    }),
                    success: function(response) {
                        $('.loading').hide();
                        console.log("Code execution response:", response);
                        
                        // Display output
                        $('#output-content').text(response.output);
                        $('#output-section').show();
                        
                        // Display figures
                        if (response.figures && response.figures.length > 0) {
                            response.figures.forEach(function(figure, index) {
                                const figureHtml = `
                                    <div class="figure-container">
                                        <h5>Figure ${index + 1}</h5>
                                        <img src="data:image/png;base64,${figure.data}" alt="Figure ${index + 1}">
                                    </div>
                                `;
                                $('#figures-container').append(figureHtml);
                            });
                        }
                        
                        console.log("Refreshing history, length:", response.history_length);
                        
                        // Wait a moment to ensure server has processed
                        setTimeout(refreshConversationHistory, 500);
                    },
                    error: function(error) {
                        $('.loading').hide();
                        console.error("Execution error:", error);
                        alert('Error executing code: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                    }
                });
            });
            
            // Send feedback
            $('#send-feedback-btn').click(function() {
                const feedback = $('#feedback-input').val().trim();
                if (!feedback) {
                    alert('Please enter feedback before sending.');
                    return;
                }
                
                $('.loading').show();
                console.log("Sending feedback...");
                
                $.ajax({
                    url: '/send_feedback',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        feedback: feedback,
                        summary: currentSummary,
                        code: currentCode
                    }),
                    success: function(response) {
                        $('.loading').hide();
                        console.log("Feedback response:", response);
                        
                        // Clear feedback input
                        $('#feedback-input').val('');
                        
                        // Hide sections
                        $('#summary-section, #code-section, #feedback-section').hide();
                        
                        console.log("Refreshing history, length:", response.history_length);
                        
                        // Wait a moment to ensure server has processed
                        setTimeout(refreshConversationHistory, 500);
                    },
                    error: function(error) {
                        $('.loading').hide();
                        console.error("Feedback error:", error);
                        alert('Error sending feedback: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                    }
                });
            });
            
            // Update conversation history
            function updateConversationHistory() {
                $.ajax({
                    url: '/get_analysis',  // Reusing this endpoint to get current state
                    type: 'GET',
                    success: function(response) {
                        // This will trigger a page refresh to show updated history
                        location.reload();
                    }
                });
            }

            // Function to refresh conversation history with direct DOM manipulation
            function refreshConversationHistory() {
                console.log("Refreshing conversation history...");
                
                // Remember the current scroll position and content height
                const historyDiv = $('#conversation-history');
                const oldScrollTop = historyDiv.scrollTop();
                const oldScrollHeight = historyDiv[0].scrollHeight;
                
                $.ajax({
                    url: '/debug/history',
                    type: 'GET',
                    success: function(response) {
                        // Store the old length before updating
                        const oldHistoryLength = $('#conversation-history .history-entry').length;
                        
                        // Update the content
                        if (response.history && response.history.length > 0) {
                            // Only rebuild if number of entries has changed
                            if (response.history.length !== oldHistoryLength) {
                                // Clear and rebuild
                                historyDiv.empty();
                                
                                response.history.forEach(function(entry) {
                                    let roleClass = 'user';
                                    let roleDisplay = 'USER';
                                    
                                    if (entry.role === 'assistant') {
                                        roleClass = 'assistant';
                                        roleDisplay = 'ASSISTANT';
                                    } else if (entry.role === 'figure') {
                                        roleClass = 'figure';
                                        roleDisplay = 'FIGURE';
                                    }
                                    
                                    // Format content properly, preserving newlines
                                    const formattedContent = entry.content.replace(/\n/g, '<br>');
                                    
                                    const entryHtml = `
                                        <div class="history-entry ${roleClass}">
                                            <strong>${roleDisplay}:</strong>
                                            <div>${formattedContent}</div>
                                        </div>
                                    `;
                                    historyDiv.append(entryHtml);
                                });
                                
                                // Handle scrolling behavior after content update
                                const newScrollHeight = historyDiv[0].scrollHeight;
                                
                                // Only auto-scroll if:
                                // 1. User is not manually scrolling, OR
                                // 2. User was already at the bottom before the update
                                const wasAtBottom = (oldScrollTop + historyDiv.innerHeight() >= oldScrollHeight - 30);
                                
                                if (!userIsScrolling || wasAtBottom) {
                                    // Scroll to bottom
                                    historyDiv.scrollTop(newScrollHeight);
                                } else {
                                    // If user was manually scrolling, maintain their relative position
                                    historyDiv.scrollTop(oldScrollTop);
                                }
                            }
                        } else if (response.history.length === 0) {
                            historyDiv.html('<p>No conversation history yet. Start by initializing the data and getting an analysis.</p>');
                        }
                    },
                    error: function(error) {
                        console.error("Error refreshing history:", error);
                    }
                });
            }


            // Add special styling for figure entries
            $('head').append(`
                <style>
                    .history-entry.figure {
                        background-color: #f8f9fa;
                        border-left: 3px solid #6c757d;
                        font-style: italic;
                    }
                    #conversation-history {
                        height: 400px;
                        overflow-y: auto;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 5px;
                        margin-bottom: 15px;
                    }
                    .history-entry {
                        margin-bottom: 10px;
                        padding: 8px;
                        border-bottom: 1px solid #eee;
                    }
                    .history-entry.assistant {
                        background-color: #f0f7ff;
                        border-left: 3px solid #0066cc;
                    }
                    .history-entry.user {
                        background-color: #f0fff0;
                        border-left: 3px solid #006600;
                    }
                </style>
            `);

            // Update Get Analysis button handler to include history refresh
            $('#get-analysis-btn').click(function() {
                $('.loading').show();
                $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                $('#figures-container').empty();
                
                $.ajax({
                    url: '/get_analysis',
                    type: 'GET',
                    success: function(response) {
                        $('.loading').hide();
                        console.log("Analysis response:", response);
                        
                        if (response.status === 'success') {
                            currentSummary = response.summary;
                            currentCode = response.code;
                            
                            // Display summary
                            $('#summary-content').html(markdownToHtml(response.summary));
                            $('#summary-section').show();
                            
                            // Display code
                            $('#code-content').text(response.code);
                            hljs.highlightElement(document.getElementById('code-content'));
                            $('#code-section').show();
                            
                            // Show feedback section
                            $('#feedback-section').show();
                            
                            // Refresh conversation history after a short delay
                            setTimeout(refreshConversationHistory, 500);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(error) {
                        $('.loading').hide();
                        console.error("Analysis error:", error);
                        alert('Error getting analysis: ' + error.responseJSON ? error.responseJSON.message : 'Unknown error');
                    }
                });
            });

            // Enforce regular history refresh
            $(document).ready(function() {
                // Initial load
                refreshConversationHistory();
                
                // Clear any existing intervals (in case of page refresh)
                if (window.historyRefreshInterval) {
                    clearInterval(window.historyRefreshInterval);
                }
                
                // Set up a less aggressive refresh interval
                window.historyRefreshInterval = setInterval(function() {
                    // Only auto-refresh if user is not actively scrolling
                    if (!userIsScrolling) {
                        refreshConversationHistory();
                    }
                }, 5000); // Every 5 seconds instead of 3
            });
            
            // Simple markdown to HTML converter (just for basic formatting)
            function markdownToHtml(markdown) {
                if (!markdown) return '';
                
                // Convert headers
                let html = markdown
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>');
                
                // Convert bold and italic
                html = html
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                // Convert lists
                html = html
                    .replace(/^\s*\d+\.\s+(.*$)/gm, '<li>$1</li>')
                    .replace(/^\s*[\-\*]\s+(.*$)/gm, '<li>$1</li>');
                
                // Wrap lists
                html = html
                    .replace(/<\/li>\n<li>/g, '</li><li>')
                    .replace(/(<li>.*?<\/li>)/s, '<ul>$1</ul>');
                
                // Convert paragraphs
                html = html
                    .replace(/\n\s*\n/g, '</p><p>')
                    .replace(/^(.+)$/gm, function(match) {
                        if (match.startsWith('<')) return match;
                        return `<p>${match}</p>`;
                    });
                
                return html;
            }
            // Add diagnostic button to HTML
            $(document).ready(function() {
                $('#initialize-btn').after('<button id="refresh-history-btn" class="btn btn-secondary ms-2">Refresh History</button>');
                
                $('#refresh-history-btn').click(function() {
                    refreshConversationHistory();
                });
            });

            // Logging middleware for debugging
            $(document).ajaxSend(function(event, jqxhr, settings) {
                console.log("Ajax request:", settings.type, settings.url);
            });

            $(document).ajaxComplete(function(event, jqxhr, settings) {
                console.log("Ajax complete:", settings.type, settings.url, "Status:", jqxhr.status);
            });
        });
    </script>
</body>
</html>

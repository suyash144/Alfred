<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive EDA with LLM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <style>
        .code-block {
            background-color: #f7f7f7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .figure-container {
            margin: 20px 0;
            text-align: center;
        }

        .figure-container img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }

        #conversation-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .history-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .assistant {
            color: #0066cc;
        }

        .user {
            color: #006600;
        }

        .feedback-input {
            height: 100px;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .history-figure {
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            background-color: #f9f9f9;
            text-align: center;
        }

        .figure {
            display: flex;
            justify-content: center;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px dashed #ccc;
            margin: 15px 0;
        }

        .figure-image {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .history-figure img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
        }

        .history-entry.figure {
            background-color: #f0f8ff;
            border-left: 3px solid #4a86e8;
        }

        .history-entry {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .button-group button {
                flex: 1 0 auto;
                margin-bottom: 8px;
            }
        }

        /* Button in execute state */
        #action-btn.btn-warning {
            background-color: #ff9800;
            border-color: #e68a00;
            transition: all 0.3s ease;
        }

        #action-btn.btn-warning:hover {
            background-color: #e68a00;
        }

        /* Button in analyze state */
        #action-btn.btn-success {
            background-color: #4caf50;
            border-color: #3d8b40;
            transition: all 0.3s ease;
        }

        #action-btn.btn-success:hover {
            background-color: #3d8b40;
        }

        /* Execute & Continue button */
        #execute-and-continue-btn {
            background-color: #2196f3;
            border-color: #0b7dda;
        }

        #execute-and-continue-btn:hover {
            background-color: #0b7dda;
        }

        /* Button transition animation */
        #action-btn {
            position: relative;
            overflow: hidden;
        }

        #action-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        #action-btn:active::after {
            transform: translateX(0);
        }
        
        /* Data source selection styles */
        .data-source-selector {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        
        .file-upload-container {
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        
        .uploaded-file-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9f7ef;
            border-radius: 5px;
            display: none;
        }
        
        #fileDetailsList {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .file-type-badge {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            margin-left: 5px;
        }
        
        .custom-prompt-container {
            margin-top: 15px;
            transition: all 0.3s ease;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="mb-4">Interactive EDA with LLM</h1>

        <!-- New Data Source Selection Section -->
        <div class="data-source-selector">
            <h3>Select Data Source</h3>
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="dataSource" id="autoGeneratedData" value="auto" checked>
                <label class="form-check-label" for="autoGeneratedData">
                    Use auto-generated test data
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="dataSource" id="customData" value="custom">
                <label class="form-check-label" for="customData">
                    Upload my own data
                </label>
            </div>
            
            <!-- File Upload Section (Initially Hidden) -->
            <div id="fileUploadSection" class="file-upload-container" style="display: none;">
                <div class="mb-3">
                    <label for="dataFile" class="form-label">Upload Data Files (.npy, .csv)</label>
                    <input class="form-control" type="file" id="dataFile" accept=".npy,.csv" multiple>
                    <div class="form-text">Supported formats: NumPy array (.npy) or CSV (.csv). You can select multiple files.</div>
                </div>
                <div id="uploadedFileInfo" class="uploaded-file-info">
                    <p>Selected Files:</p>
                    <ul id="fileDetailsList" class="list-group">
                        <li class="list-group-item text-muted">No files selected</li>
                    </ul>
                </div>
            </div>
            
            <!-- Custom Prompt Section -->
            <div class="custom-prompt-container">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="useCustomPrompt">
                    <label class="form-check-label" for="useCustomPrompt">
                        Use custom initial prompt
                    </label>
                </div>
                <div id="customPromptSection" style="display: none;">
                    <div class="mb-3">
                        <label for="customPromptText" class="form-label">Enter your custom prompt</label>
                        <textarea class="form-control" id="customPromptText" rows="4" placeholder="Give an initial description of your data (e.g. dimensionality) and what you would like to find out."></textarea>
                        <div class="form-text">Your custom prompt will be added to the default analysis instruction.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col">
                <button id="initialize-btn" class="btn btn-primary">Initialise Dataset</button>
                <!-- <button id="get-analysis-btn" class="btn btn-success">Refresh History</button> -->
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h3>Conversation History</h3>
                <div id="conversation-history">
                    <!-- History will be loaded dynamically via JavaScript -->
                    <p>Loading conversation history...</p>
                </div>
            </div>

            <div class="col-md-6">
                <h3>Current Analysis</h3>
                <div id="current-analysis">
                    <div id="summary-section" style="display: none;">
                        <h4>Summary</h4>
                        <div id="summary-content" class="mb-4 p-3 border rounded"></div>
                    </div>

                    <div id="code-section" style="display: none;">
                        <h4>Proposed Code</h4>
                        <pre><code id="code-content" class="python"></code></pre>
                        <div class="button-group mt-3 mb-4">
                            <button id="action-btn" class="btn btn-warning">Execute Code</button>
                            <!-- <button id="execute-and-analyze-btn" class="btn btn-info ms-2">Execute & Continue</button> -->
                        </div>
                    </div>

                    <div id="feedback-section" style="display: none;">
                        <h4>Provide Feedback</h4>
                        <textarea id="feedback-input" class="form-control feedback-input mb-2"
                            placeholder="Enter your feedback here..."></textarea>
                        <button id="send-feedback-btn" class="btn btn-info">Send Feedback</button>
                    </div>

                    <div class="loading text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Processing...</p>
                    </div>
                </div>

                <div id="output-section" style="display: none;">
                    <h4>Execution Output</h4>
                    <pre id="output-content" class="p-3 border rounded bg-light"></pre>
                </div>

                <div id="figures-container">
                    <!-- Figures will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script>
        $(document).ready(function () {
            let currentSummary = '';
            let currentCode = '';
            let buttonState = 'execute';
            let selectedFiles = [];

            // Toggle file upload section based on data source selection
            $('input[name="dataSource"]').change(function() {
                if ($(this).val() === 'custom') {
                    $('#fileUploadSection').slideDown();
                } else {
                    $('#fileUploadSection').slideUp();
                }
            });
            
            // Toggle custom prompt section
            $('#useCustomPrompt').change(function() {
                if ($(this).is(':checked')) {
                    $('#customPromptSection').slideDown();
                } else {
                    $('#customPromptSection').slideUp();
                }
            });
            
            // Handle multiple file selection
            $('#dataFile').change(function(e) {
                const files = e.target.files;
                if (files && files.length > 0) {
                    selectedFiles = Array.from(files);
                    $('#uploadedFileInfo').show();
                    
                    // Clear and rebuild the file list
                    const $fileList = $('#fileDetailsList').empty();
                    
                    selectedFiles.forEach(function(file, index) {
                        const fileSize = (file.size / 1024).toFixed(2);
                        const fileType = file.name.split('.').pop().toLowerCase();
                        const fileIcon = fileType === 'csv' ? '📊' : '📁';
                        
                        $fileList.append(`
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${fileIcon} <strong>${file.name}</strong>
                                <span class="badge bg-primary rounded-pill">${fileSize} KB</span>
                            </li>
                        `);
                    });
                    
                    // Add a summary message at the top
                    $('#uploadedFileInfo p').text(`Selected ${files.length} file${files.length > 1 ? 's' : ''}:`);
                    
                } else {
                    selectedFiles = [];
                    $('#fileDetailsList').html('<li class="list-group-item text-muted">No files selected</li>');
                    $('#uploadedFileInfo p').text('Selected Files:');
                }
            });

            // Modified initialize dataset function
            $('#initialize-btn').click(function () {
                $('.loading').show();
                
                // Create a FormData object to handle file uploads
                const formData = new FormData();
                
                // Add data source type
                const dataSource = $('input[name="dataSource"]:checked').val();
                formData.append('dataSource', dataSource);
                
                // Add custom files if selected
                if (dataSource === 'custom' && selectedFiles.length > 0) {
                    // Append each file with a unique key (dataFile_0, dataFile_1, etc.)
                    selectedFiles.forEach((file, index) => {
                        formData.append(`dataFile_${index}`, file);
                    });
                    // Also add the file count for server-side processing
                    formData.append('fileCount', selectedFiles.length);
                } else if (dataSource === 'custom' && selectedFiles.length === 0) {
                    alert('Please select at least one file to upload');
                    $('.loading').hide();
                    return;
                }
                
                // Add custom prompt if specified
                if ($('#useCustomPrompt').is(':checked')) {
                    const customPrompt = $('#customPromptText').val().trim();
                    if (customPrompt) {
                        formData.append('customPrompt', customPrompt);
                    }
                }
                
                $.ajax({
                    url: '/initialize',
                    type: 'POST',
                    data: formData,
                    processData: false,  // Important for FormData
                    contentType: false,  // Important for FormData
                    success: function (response) {
                        alert(response.message);
                        // Clear conversation history
                        $('#conversation-history').empty();
                        // Clear current analysis
                        $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                        $('#figures-container').empty();
                        console.log("Dataset initialised successfully");
                        console.log("Getting first analysis...");
                        
                        // Keep loading indicator visible
                        $.ajax({
                            url: '/get_analysis',
                            type: 'GET',
                            success: function (response) {
                                $('.loading').hide();
                                console.log("Analysis response:", response);

                                if (response.status === 'success') {
                                    currentSummary = response.summary;
                                    currentCode = response.code;

                                    // Display summary
                                    $('#summary-content').html(markdownToHtml(response.summary));
                                    $('#summary-section').show();

                                    // Display code
                                    $('#code-content').text(response.code);
                                    hljs.highlightElement(document.getElementById('code-content'));
                                    $('#code-section').show();

                                    // Show feedback section
                                    $('#feedback-section').show();

                                    // Refresh conversation history after a short delay
                                    setTimeout(refreshConversationHistory, 500);

                                    // Set button to execute state
                                    setButtonState('execute');
                                } else {
                                    alert('Error: ' + response.message);
                                }
                            },
                            error: function (error) {
                                $('.loading').hide();
                                console.error("Analysis error:", error);
                                alert('Error getting analysis: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                            }
                        });
                    },
                    error: function (error) {
                        $('.loading').hide();
                        alert('Error initializing data: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                    }
                });
            });

            // Dynamic action button - changes function based on state
            $('#action-btn').click(function () {
                if (buttonState === 'execute') {
                    executeCode();
                } else {
                    getNextAnalysis();
                }
            });

            // Function to set button state and update appearance
            function setButtonState(state) {
                buttonState = state;
                const actionBtn = $('#action-btn');

                if (state === 'execute') {
                    actionBtn.text('Execute Code');
                    actionBtn.removeClass('btn-success').addClass('btn-warning');
                } else {
                    actionBtn.text('Get Next Analysis');
                    actionBtn.removeClass('btn-warning').addClass('btn-success');
                }
            }

            // Function to execute code
            function executeCode() {
                $('.loading').show();
                $('#output-section').hide();
                $('#figures-container').empty();

                console.log("Executing code...");

                $.ajax({
                    url: '/execute_code',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        code: currentCode,
                        summary: currentSummary
                    }),
                    success: function (response) {
                        $('.loading').hide();
                        console.log("Code execution response:", response);

                        // Display output
                        $('#output-content').text(response.output);
                        $('#output-section').show();

                        // Display figures
                        if (response.figures && response.figures.length > 0) {
                            response.figures.forEach(function (figure, index) {
                                const figureHtml = `
                                    <div class="figure-container">
                                        <h5>Figure ${index + 1}</h5>
                                        <img src="data:image/png;base64,${figure.data}" alt="Figure ${index + 1}">
                                    </div>
                                `;
                                $('#figures-container').append(figureHtml);
                            });
                        }
                        // Refresh conversation history after a short delay
                        setTimeout(refreshConversationHistory, 500);

                        // Transform the button to "Get Next Analysis"
                        setButtonState('analyze');
                    },
                    error: function (error) {
                        $('.loading').hide();
                        console.error("Execution error:", error);
                        alert('Error executing code: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                    }
                });
            }

            function getNextAnalysis() {
                $('.loading').show();
                $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                $('#figures-container').empty();

                $.ajax({
                    url: '/get_analysis',
                    type: 'GET',
                    success: function (response) {
                        $('.loading').hide();
                        console.log("Analysis response:", response);

                        if (response.status === 'success') {
                            currentSummary = response.summary;
                            currentCode = response.code;

                            // Display summary
                            $('#summary-content').html(markdownToHtml(response.summary));
                            $('#summary-section').show();

                            // Display code
                            $('#code-content').text(response.code);
                            hljs.highlightElement(document.getElementById('code-content'));
                            $('#code-section').show();

                            // Show feedback section
                            $('#feedback-section').show();

                            // Refresh conversation history after a short delay
                            setTimeout(refreshConversationHistory, 500);

                            // Transform the button back to "Execute Code"
                            setButtonState('execute');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (error) {
                        $('.loading').hide();
                        console.error("Analysis error:", error);
                        alert('Error getting analysis: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                    }
                });
            }

            let userIsScrolling = false;
            let lastScrollTop = 0;

            // Detect manual scrolling
            $('#conversation-history').on('scroll', function () {
                userIsScrolling = true;
                lastScrollTop = $(this).scrollTop();

                // Reset the flag after 2 seconds of no scrolling
                clearTimeout($.data(this, 'scrollTimer'));
                $.data(this, 'scrollTimer', setTimeout(function () {
                    userIsScrolling = false;
                }, 2000));
            });

            // Send feedback button
            $('#send-feedback-btn').click(function () {
                const feedback = $('#feedback-input').val().trim();
                if (!feedback) {
                    alert('Please enter feedback before sending.');
                    return;
                }

                $('.loading').show();
                console.log("Sending feedback and getting next analysis...");

                $.ajax({
                    url: '/send_feedback',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        feedback: feedback,
                        summary: currentSummary,
                        code: currentCode
                    }),
                    success: function (response) {
                        console.log("Feedback response:", response);

                        // Clear feedback input
                        $('#feedback-input').val('');

                        // Hide sections during transition
                        $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                        $('#figures-container').empty();

                        // First refresh conversation history
                        refreshConversationHistory();

                        // Check if we have a next analysis from the server
                        if (response.next_analysis) {
                            // Update with the new analysis data
                            currentSummary = response.next_analysis.summary;
                            currentCode = response.next_analysis.code;

                            // Display summary
                            $('#summary-content').html(markdownToHtml(response.next_analysis.summary));
                            $('#summary-section').show();

                            // Display code
                            $('#code-content').text(response.next_analysis.code);
                            hljs.highlightElement(document.getElementById('code-content'));
                            $('#code-section').show();

                            // Show feedback section
                            $('#feedback-section').show();

                            // Set button to execute state
                            setButtonState('execute');

                            // Hide loading indicator when complete
                            $('.loading').hide();

                            // Final refresh of conversation history to ensure everything is up to date
                            setTimeout(refreshConversationHistory, 500);
                        } else if (response.error) {
                            // If there was an error getting the next analysis
                            $('.loading').hide();
                            alert('Note: Your feedback was sent, but there was an error getting the next analysis: ' + response.error);
                        } else {
                            // If response doesn't contain next_analysis for some reason
                            $('.loading').hide();
                            alert('Your feedback was sent successfully, but no next analysis was received.');
                        }
                    },
                    error: function (error) {
                        $('.loading').hide();
                        console.error("Feedback error:", error);
                        alert('Error sending feedback: ' + (error.responseJSON ? error.responseJSON.message : 'Unknown error'));
                    }
                });
            });

            // Function to refresh conversation history with direct DOM manipulation
            function refreshConversationHistory() {
                console.log("Refreshing conversation history...");

                // Remember the current scroll position and content height
                const historyDiv = $('#conversation-history');
                const oldScrollTop = historyDiv.scrollTop();
                const oldScrollHeight = historyDiv[0].scrollHeight;

                $.ajax({
                    url: '/debug/history',
                    type: 'GET',
                    success: function (response) {
                        // Store the old length before updating
                        const oldHistoryLength = $('#conversation-history .history-entry').length;

                        // Update the content
                        if (response.history && response.history.length > 0) {
                            // Only rebuild if number of entries has changed
                            if (response.history.length !== oldHistoryLength) {
                                // Clear and rebuild
                                historyDiv.empty();

                                response.history.forEach(function (entry) {
                                    let roleClass = 'user';
                                    let roleDisplay = 'USER';
                                    let entryHtml = '';

                                    if (entry.role === 'assistant') {
                                        roleClass = 'assistant';
                                        roleDisplay = 'ASSISTANT';
                                        // For non-figure entries
                                        const formattedContent = typeof entry.content === 'string'
                                            ? entry.content.replace(/\n/g, '<br>')
                                            : JSON.stringify(entry.content);

                                        entryHtml = `
                                            <div class="history-entry ${roleClass}">
                                                <strong>${roleDisplay}:</strong>
                                                <div>${formattedContent}</div>
                                            </div>
                                        `;
                                    } else if (entry.role === 'figure') {
                                        roleClass = 'figure';
                                        roleDisplay = 'FIGURE';

                                        // Special handling for figure entries
                                        entryHtml = `
                                            <div class="history-entry ${roleClass}">
                                                <img src="${entry.content}" alt="Figure" class="figure-image">
                                            </div>
                                        `;
                                    } else {
                                        // For non-figure entries
                                        const formattedContent = typeof entry.content === 'string'
                                            ? entry.content.replace(/\n/g, '<br>')
                                            : JSON.stringify(entry.content);

                                        entryHtml = `
                                            <div class="history-entry ${roleClass}">
                                                <strong>${roleDisplay}:</strong>
                                                <div>${formattedContent}</div>
                                            </div>
                                        `;
                                    }

                                    historyDiv.append(entryHtml);
                                });

                                // Handle scrolling behavior after content update
                                const newScrollHeight = historyDiv[0].scrollHeight;

                                // Only auto-scroll if:
                                // 1. User is not manually scrolling, OR
                                // 2. User was already at the bottom before the update
                                const wasAtBottom = (oldScrollTop + historyDiv.innerHeight() >= oldScrollHeight - 30);

                                if (!userIsScrolling || wasAtBottom) {
                                    // Scroll to bottom
                                    historyDiv.scrollTop(newScrollHeight);
                                } else {
                                    // If user was manually scrolling, maintain their relative position
                                    historyDiv.scrollTop(oldScrollTop);
                                }
                            }
                        } else if (response.history.length === 0) {
                            historyDiv.html('<p>No conversation history yet. Start by initialising the data and getting an analysis.</p>');
                        }
                    },
                    error: function (error) {
                        console.error("Error refreshing history:", error);
                    }
                });
            }

            // Update Get Analysis button handler to include history refresh
            $('#get-analysis-btn').click(function () {
                $('.loading').show();
                $('#summary-section, #code-section, #feedback-section, #output-section').hide();
                $('#figures-container').empty();

                $.ajax({
                    url: '/get_analysis',
                    type: 'GET',
                    success: function (response) {
                        $('.loading').hide();
                        console.log("Analysis response:", response);

                        if (response.status === 'success') {
                            currentSummary = response.summary;
                            currentCode = response.code;

                            // Display summary
                            $('#summary-content').html(markdownToHtml(response.summary));
                            $('#summary-section').show();

                            // Display code
                            $('#code-content').text(response.code);
                            hljs.highlightElement(document.getElementById('code-content'));
                            $('#code-section').show();

                            // Show feedback section
                            $('#feedback-section').show();

                            // Refresh conversation history after a short delay
                            setTimeout(refreshConversationHistory, 500);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function (error) {
                        $('.loading').hide();
                        console.error("Analysis error:", error);
                        alert('Error getting analysis: ' + error.responseJSON ? error.responseJSON.message : 'Unknown error');
                    }
                });
            });

            // Enforce regular history refresh
            $(document).ready(function () {
                // Initial load
                refreshConversationHistory();

                // Clear any existing intervals (in case of page refresh)
                if (window.historyRefreshInterval) {
                    clearInterval(window.historyRefreshInterval);
                }

                // Set up a less aggressive refresh interval
                window.historyRefreshInterval = setInterval(function () {
                    // Only auto-refresh if user is not actively scrolling
                    if (!userIsScrolling) {
                        refreshConversationHistory();
                    }
                }, 5000); // Every 5 seconds instead of 3
            });

            // Simple markdown to HTML converter (just for basic formatting)
            function markdownToHtml(markdown) {
                if (!markdown) return '';

                // Convert headers
                let html = markdown
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>');

                // Convert bold and italic
                html = html
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');

                // Convert lists
                html = html
                    .replace(/^\s*\d+\.\s+(.*$)/gm, '<li>$1</li>')
                    .replace(/^\s*[\-\*]\s+(.*$)/gm, '<li>$1</li>');

                // Wrap lists
                html = html
                    .replace(/<\/li>\n<li>/g, '</li><li>')
                    .replace(/(<li>.*?<\/li>)/s, '<ul>$1</ul>');

                // Convert paragraphs
                html = html
                    .replace(/\n\s*\n/g, '</p><p>')
                    .replace(/^(.+)$/gm, function (match) {
                        if (match.startsWith('<')) return match;
                        return `<p>${match}</p>`;
                    });

                return html;
            }

            // Logging middleware for debugging
            $(document).ajaxSend(function (event, jqxhr, settings) {
                console.log("Ajax request:", settings.type, settings.url);
            });

            $(document).ajaxComplete(function (event, jqxhr, settings) {
                console.log("Ajax complete:", settings.type, settings.url, "Status:", jqxhr.status);
            });
        });
    </script>
</body>

</html>